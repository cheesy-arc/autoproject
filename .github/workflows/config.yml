name: UI Tests

on: [push]

jobs:
  ui-tests:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Клонируем репозиторий
    - name: Checkout code
      uses: actions/checkout@v4

    # 2️⃣ Устанавливаем Docker (ubuntu-latest уже имеет Docker, но на всякий случай)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 3️⃣ Запускаем тесты внутри контейнера
    - name: Run UI-tests via Docker Compose
      env:
        LOGIN: ${{ secrets.LOGIN }}
        PASSWORD: ${{ secrets.PASSWORD }}
      run: |
        # Создаём директорию для результатов Allure
        mkdir -p ./allure-results

        # Запуск контейнера с монтированием папки для результатов
        docker compose run \
          -v $PWD/allure-results:/usr/workspace/allure-results \
          regression \
          pytest -sv --alluredir=/usr/workspace/allure-results

    # 4️⃣ Устанавливаем Allure CLI на хосте
    - name: Install Allure CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jre unzip curl
        curl -o allure.tgz -Ls https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.13.8/allure-commandline-2.13.8.tgz
        sudo tar -zxvf allure.tgz -C /opt/
        sudo ln -s /opt/allure-2.13.8/bin/allure /usr/bin/allure

    # 5️⃣ Генерация Allure отчёта на хосте
    - name: Generate Allure report
      run: |
        mkdir -p allure-report
        allure generate allure-results --clean -o allure-report
        ls -la allure-report  # проверяем, что отчёт сгенерировался

    # 6️⃣ Деплой отчёта на GitHub Pages
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4.1.5
      with:
        token: ${{ secrets.CI_TOKEN }}
        branch: gh-pages
        folder: allure-report
        clean: true